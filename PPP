import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.impl.conn.PoolingHttpClientConnectionManager; // Import this
import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RestClientConfig {

    @Bean
    public RestTemplate restTemplate() {

        // 1. Configure Connection Pooling (CRITICAL for Service Bus)
        PoolingHttpClientConnectionManager connectionManager = new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(200);        // Total connections allowed globally
        connectionManager.setDefaultMaxPerRoute(50); // Max connections to ONE server (Synergy)
        // Set this to match your Service Bus 'maxConcurrentSessions'

        // 2. Build the Client with the Pool
        CloseableHttpClient httpClient = HttpClients.custom()
                .setConnectionManager(connectionManager)
                .build();

        HttpComponentsClientHttpRequestFactory factory =
                new HttpComponentsClientHttpRequestFactory(httpClient);

        // 3. Timeouts (Updated to your preference)
        factory.setConnectTimeout(3000);  // 3s (Connect fast or fail)
        factory.setReadTimeout(50000);    // 50s (Wait for slow email server)

        return new RestTemplate(factory);
    }
}
