# windows-classic-task.yml
trigger: [ main ]

pool:
  vmImage: 'windows-latest'

variables:
  AZ_SUBSCRIPTION: 'My-Service-Connection'     # DevOps service connection
  AZ_SUB_ID: '00000000-0000-0000-0000-000000000000'
  AZ_RG: 'rg-func-win-classic'
  AZ_APP: 'func-win-classic-app'               # Windows Function App (classic)
  ARTIFACT_NAME: 'drop'

steps:
- checkout: self

- task: Maven@4
  displayName: 'Build (mvn clean package)'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    jdkVersionOption: '1.21'

# Find Functions staging dir: target/azure-functions/<appName>/
- powershell: |
    $staging = Get-ChildItem -Recurse -Directory |
      Where-Object { $_.FullName -match 'target\\azure-functions\\[^\\]+$' } |
      Select-Object -First 1
    if (-not $staging) { throw "Functions staging folder not found." }
    echo "##vso[task.setvariable variable=STAGING_DIR]$($staging.FullName)"
  displayName: 'Locate staging directory'

- task: ArchiveFiles@2
  displayName: 'Create ZIP from staging'
  inputs:
    rootFolderOrFile: '$(STAGING_DIR)'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/functions.zip'
    replaceExistingArchive: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(ARTIFACT_NAME)'

# Deploy ZIP via Kudu (task handles classic plans well)
- task: AzureFunctionApp@2
  displayName: 'Deploy to Windows Function App (classic)'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    appName: '$(AZ_APP)'
    package: '$(Build.ArtifactStagingDirectory)/functions.zip'

# Deterministic trigger registration
- task: AzureCLI@2
  displayName: 'Sync triggers'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az rest --method post `
        --url "https://management.azure.com/subscriptions/$(AZ_SUB_ID)/resourceGroups/$(AZ_RG)/providers/Microsoft.Web/sites/$(AZ_APP)/syncfunctiontriggers?api-version=2025-03-01"



======

# windows-classic-cli.yml
trigger: [ main ]

pool:
  vmImage: 'windows-latest'

variables:
  AZ_SUBSCRIPTION: 'My-Service-Connection'
  AZ_SUB_ID: '00000000-0000-0000-0000-000000000000'
  AZ_RG: 'rg-func-win-classic'
  AZ_APP: 'func-win-classic-app'

steps:
- checkout: self

- task: Maven@4
  displayName: 'Build (mvn clean package)'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    jdkVersionOption: '1.21'

- powershell: |
    $staging = Get-ChildItem -Recurse -Directory |
      Where-Object { $_.FullName -match 'target\\azure-functions\$begin:math:display$^\\$end:math:display$+$' } |
      Select-Object -First 1
    if (-not $staging) { throw "Functions staging folder not found." }
    $zipOut = "$(Build.ArtifactStagingDirectory)\functions.zip"
    if (Test-Path $zipOut) { Remove-Item $zipOut -Force }
    Compress-Archive -Path (Join-Path $staging.FullName '*') -DestinationPath $zipOut -Force
    Write-Host "##vso[task.setvariable variable=ZIP_PATH]$zipOut"
  displayName: 'Zip staging (PowerShell)'

- task: AzureCLI@2
  displayName: 'Deploy (config-zip) + Sync triggers'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az functionapp deployment source config-zip -g "$(AZ_RG)" -n "$(AZ_APP)" --src "$(ZIP_PATH)"
      az rest --method post `
        --url "https://management.azure.com/subscriptions/$(AZ_SUB_ID)/resourceGroups/$(AZ_RG)/providers/Microsoft.Web/sites/$(AZ_APP)/syncfunctiontriggers?api-version=2025-03-01"


=======

# linux-classic-task.yml
trigger: [ main ]

pool:
  vmImage: 'ubuntu-latest'

variables:
  AZ_SUBSCRIPTION: 'My-Service-Connection'
  AZ_SUB_ID: '00000000-0000-0000-0000-000000000000'
  AZ_RG: 'rg-func-linux-classic'
  AZ_APP: 'func-linux-classic-app'
  ARTIFACT_NAME: 'drop'

steps:
- checkout: self

- task: Maven@4
  displayName: 'Build (mvn clean package)'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    jdkVersionOption: '1.21'

# Find staging and zip with task
- bash: |
    staging=$(find . -path "*/target/azure-functions/*" -type d -maxdepth 5 | head -n 1)
    if [ -z "$staging" ]; then echo "Staging folder not found"; exit 1; fi
    echo "##vso[task.setvariable variable=STAGING_DIR]$staging"
  displayName: 'Locate staging directory'

- task: ArchiveFiles@2
  displayName: 'Create ZIP from staging'
  inputs:
    rootFolderOrFile: '$(STAGING_DIR)'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/functions.zip'
    replaceExistingArchive: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(ARTIFACT_NAME)'

- task: AzureFunctionApp@2
  displayName: 'Deploy to Linux Function App (classic)'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    appName: '$(AZ_APP)'
    package: '$(Build.ArtifactStagingDirectory)/functions.zip'

- task: AzureCLI@2
  displayName: 'Sync triggers'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az rest --method post \
        --url "https://management.azure.com/subscriptions/$(AZ_SUB_ID)/resourceGroups/$(AZ_RG)/providers/Microsoft.Web/sites/$(AZ_APP)/syncfunctiontriggers?api-version=2025-03-01"

======
# linux-flex-consumption.yml
trigger: [ main ]

pool:
  vmImage: 'ubuntu-latest'

variables:
  AZ_SUBSCRIPTION: 'My-Service-Connection'
  AZ_SUB_ID: '00000000-0000-0000-0000-000000000000'
  AZ_RG: 'rg-func-linux-flex'
  AZ_APP: 'func-linux-flex-app'     # Flex Function App (Linux only)

steps:
- checkout: self

# 1️⃣ Build
- task: Maven@4
  displayName: 'Build Java Azure Function'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    jdkVersionOption: '1.21'

# 2️⃣ Zip the Functions staging folder
- bash: |
    staging=$(find . -path "*/target/azure-functions/*" -type d -maxdepth 5 | head -n 1)
    if [ -z "$staging" ]; then echo "Staging folder not found"; exit 1; fi
    zipOut="$(dirname "$staging")/$(basename "$staging").zip"
    (cd "$staging" && zip -r "$zipOut" .)
    echo "##vso[task.setvariable variable=ZIP_PATH]$zipOut"
  displayName: 'Create ZIP package'

# 3️⃣ Deploy with OneDeploy
- task: AzureCLI@2
  displayName: 'Deploy ZIP to Flex Function App'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      # No WEBSITE_RUN_FROM_PACKAGE in Flex
      az functionapp deploy --src-path "$(ZIP_PATH)" --type zip -g "$(AZ_RG)" -n "$(AZ_APP)"

# 4️⃣ Sync triggers (must-have for Cosmos DB / Service Bus)
- task: AzureCLI@2
  displayName: 'Sync triggers (Flex)'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az rest --method post \
        --url "https://management.azure.com/subscriptions/$(AZ_SUB_ID)/resourceGroups/$(AZ_RG)/providers/Microsoft.Web/sites/$(AZ_APP)/syncfunctiontriggers?api-version=2025-03-01"

