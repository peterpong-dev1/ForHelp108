import com.azure.messaging.servicebus.*
import com.azure.messaging.servicebus.models.*

// Get variables from JMeter
String connectionString = vars.get("ConnectionString")
String queueName = vars.get("QueueName")

// Build a unique message per thread
String messageBody = "This is message from thread " + vars.get("__threadNum") + " at " + System.currentTimeMillis()

ServiceBusSenderClient sender = null
try {
    // Build the sender client
    sender = new ServiceBusClientBuilder()
        .connectionString(connectionString)
        .sender()
        .queueName(queueName)
        .buildClient()

    // Send the message
    sender.sendMessage(new ServiceBusMessage(messageBody))

    // Mark JMeter result as successful
    SampleResult.setSuccessful(true)
    SampleResult.setResponseCode("200")
    SampleResult.setResponseMessage("Message sent successfully")
} catch (Exception e) {
    SampleResult.setSuccessful(false)
    SampleResult.setResponseCode("500")
    SampleResult.setResponseMessage("Error: " + e.toString())
    log.error("Failed to send to Service Bus: ", e)
} finally {
    if (sender != null) {
        sender.close()
    }
}