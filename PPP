trigger:
- main

variables:
  AZ_SUBSCRIPTION: 'POC-KBSB'              # your Azure service connection name
  AZ_RESOURCE_GROUP: 'poc-rg'              # your resource group
  AZ_APP: 'pocfunctionapp'                 # your Function App name
  ARTIFACT_NAME: 'drop'

pool:
  vmImage: 'windows-latest'

steps:
# 1️⃣ Checkout code
- checkout: self

# 2️⃣ Build using Maven
- task: Maven@4
  displayName: 'Build (mvn clean package)'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    jdkVersionOption: '1.21'

# 3️⃣ Download latest Datadog Java agent
- powershell: |
    Write-Host "Downloading latest Datadog Java agent..."
    $targetPath = "$(Build.SourcesDirectory)\datadog"
    New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
    Invoke-WebRequest -Uri "https://dtdg.co/latest-java-tracer" -OutFile "$targetPath\dd-java-agent.jar"
  displayName: 'Download Datadog Java Agent'

# 4️⃣ Find Azure Functions staging directory (created by Maven)
- powershell: |
    $staging = Get-ChildItem -Recurse -Directory |
      Where-Object { $_.FullName -match 'target\\azure-functions\\[^\\]+$' } |
      Select-Object -First 1
    if (-not $staging) { throw "Functions staging folder not found." }
    echo "##vso[task.setvariable variable=STAGING_DIR]$($staging.FullName)"
  displayName: 'Locate staging directory'

# 5️⃣ Copy Datadog JAR into staging dir
- powershell: |
    Write-Host "Copying Datadog agent to staging folder..."
    Copy-Item "$(Build.SourcesDirectory)\datadog\dd-java-agent.jar" -Destination "$(STAGING_DIR)\datadog" -Force
  displayName: 'Copy Datadog agent to staging directory'

# 6️⃣ Create ZIP for deployment
- task: ArchiveFiles@2
  displayName: 'Create ZIP from staging'
  inputs:
    rootFolderOrFile: '$(STAGING_DIR)'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/functions.zip'
    replaceExistingArchive: true

# 7️⃣ Publish build artifact
- task: PublishBuildArtifacts@1
  displayName: 'Publish artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: '$(ARTIFACT_NAME)'

# 8️⃣ Deploy ZIP to Azure Function App
- task: AzureFunctionApp@2
  displayName: 'Deploy to Windows Function App (classic)'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    appName: '$(AZ_APP)'
    package: '$(Build.ArtifactStagingDirectory)/functions.zip'

# 9️⃣ Sync triggers
- task: AzureCLI@2
  displayName: 'Sync triggers'
  inputs:
    azureSubscription: '$(AZ_SUBSCRIPTION)'
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az rest --method post `
        --url "https://management.azure.com/subscriptions/$(AZ_SUBSCRIPTION)/resourceGroups/$(AZ_RESOURCE_GROUP)/providers/Microsoft.Web/sites/$(AZ_APP)/syncfunctiontriggers?api-version=2022-03-01"