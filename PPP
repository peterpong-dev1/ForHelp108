pool:
  vmImage: 'ubuntu-latest'

steps:

# Build Java Function
- task: Maven@4
  displayName: "Build (mvn clean package)"
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean package'
    options: '-DskipTests'
    jdkVersionOption: '1.21'

# Download Datadog Java agent
- script: |
    curl -L -o "$(Build.SourcesDirectory)/dd-java-agent.jar" https://dtdg.co/latest-java-tracer
  displayName: "Download Datadog Java Agent"

# Locate staging directory (target/azure-functions/<appName>)
- script: |
    echo "Searching for function staging directory..."
    STAGING_DIR=$(find target -type d -path "*/azure-functions/*" | head -n 1)
    if [ -z "$STAGING_DIR" ]; then
      echo "ERROR: Staging directory not found."
      exit 1
    fi
    echo "Found staging directory: $STAGING_DIR"
    echo "##vso[task.setvariable variable=STAGING_DIR]$STAGING_DIR"
  displayName: "Locate staging directory"
  shell: bash

# Copy Datadog agent into staging directory
- script: |
    cp "$(Build.SourcesDirectory)/dd-java-agent.jar" "$STAGING_DIR"
    echo "Datadog agent added."
  displayName: "Copy Datadog agent to staging"

# Create ZIP package
- task: ArchiveFiles@2
  displayName: "Create ZIP from staging"
  inputs:
    rootFolderOrFile: "$(STAGING_DIR)"
    includeRootFolder: false
    archiveFile: "$(Build.ArtifactStagingDirectory)/functions.zip"
    replaceExistingArchive: true

# Publish artifact
- task: PublishBuildArtifacts@1
  displayName: "Publish artifact"
  inputs:
    PathtoPublish: "$(Build.ArtifactStagingDirectory)"
    ArtifactName: "functions"

# Deploy ZIP to Linux Function App (Premium)
- task: AzureCLI@2
  displayName: "Deploy to Linux Function App"
  inputs:
    azureSubscription: "$(AZ_SUBSCRIPTION)"
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "Deploying ZIP to Linux Function App..."
      az functionapp deployment source config-zip \
        --resource-group "$(AZ_RG)" \
        --name "$(AZ_APP)" \
        --src "$(Build.ArtifactStagingDirectory)/functions.zip"

# Sync triggers (Linux required)
- task: AzureCLI@2
  displayName: "Sync triggers"
  inputs:
    azureSubscription: "$(AZ_SUBSCRIPTION)"
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      echo "Syncing triggers..."
      az rest --method post \
        --url "https://management.azure.com/subscriptions/$(AZ_SUB_ID)/resourceGroups/$(AZ_RG)/providers/Microsoft.Web/sites/$(AZ_APP)/syncfunctiontriggers?api-version=2022-03-01"